<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oaxaca City ‚Äî Feb & Mar 2026 Events</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F5F0E8;
    --bg-card: #FFFDF8;
    --text: #2C2418;
    --text-muted: #7A6F60;
    --border: #E0D6C8;
    --shadow: rgba(44,36,24,0.08);
    --community: #B85C38; --community-bg: #FDF0EB;
    --music: #5C3D8F; --music-bg: #F3EEF9;
    --yoga: #2D7D5F; --yoga-bg: #EAF5F0;
    --festival: #C4421A; --festival-bg: #FDE8E1;
    --arts: #C08B30; --arts-bg: #FBF4E4;
    --food: #8B6C42; --food-bg: #F8F2E8;
    --hiking: #3A7CA5; --hiking-bg: #E8F1F7;
    --family: #D4785C; --family-bg: #FDF0EB;
    --dance: #A63D82; --dance-bg: #F8EBF4;
    --cowork: #5A7052; --cowork-bg: #EEF3EC;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }

  /* HERO */
  .hero {
    position: relative;
    height: 340px;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }
  .hero-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.55) saturate(1.2);
  }
  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(44,36,24,0.85) 0%, rgba(44,36,24,0.3) 50%, rgba(44,36,24,0.15) 100%);
  }
  .hero-content {
    position: relative;
    z-index: 2;
    text-align: center;
    color: #F5F0E8;
    padding: 0 24px 40px;
  }
  .hero-content h1 {
    font-family:'Playfair Display',serif;
    font-weight:900;
    font-size: clamp(2.4rem,6vw,3.8rem);
    letter-spacing:-0.02em;
    text-shadow: 0 2px 20px rgba(0,0,0,0.4);
  }
  .hero-content h1 span { color:#E8C36A; }
  .hero-content p {
    font-size:1rem;
    opacity:0.8;
    margin-top:6px;
    text-shadow: 0 1px 8px rgba(0,0,0,0.5);
  }
  .hero-credit {
    position:absolute;
    bottom:8px;
    right:12px;
    z-index:3;
    font-size:0.6rem;
    color:rgba(255,255,255,0.4);
  }
  .hero-credit a { color:rgba(255,255,255,0.5); text-decoration:none; }
  .hero-credit a:hover { color:rgba(255,255,255,0.8); }

  .container { max-width:1100px; margin:0 auto; padding:0 16px; }

  /* FILTERS */
  .filters-section {
    position:sticky; top:0; z-index:100;
    background:var(--bg);
    padding:14px 0 10px;
    border-bottom:1px solid var(--border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .filters-wrap { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .filter-btn {
    display:inline-flex; align-items:center; gap:5px;
    padding:5px 12px; border-radius:20px; border:2px solid;
    font-family:'DM Sans',sans-serif; font-size:0.75rem; font-weight:600;
    cursor:pointer; transition:all 0.2s; user-select:none; background:white;
  }
  .filter-btn .dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
  .filter-btn.off { opacity:0.3; background:transparent; }
  .filter-btn.off .dot { opacity:0.4; }
  .filter-btn[data-cat="community"] { border-color:var(--community); color:var(--community); }
  .filter-btn[data-cat="community"] .dot { background:var(--community); }
  .filter-btn[data-cat="music"] { border-color:var(--music); color:var(--music); }
  .filter-btn[data-cat="music"] .dot { background:var(--music); }
  .filter-btn[data-cat="yoga"] { border-color:var(--yoga); color:var(--yoga); }
  .filter-btn[data-cat="yoga"] .dot { background:var(--yoga); }
  .filter-btn[data-cat="festival"] { border-color:var(--festival); color:var(--festival); }
  .filter-btn[data-cat="festival"] .dot { background:var(--festival); }
  .filter-btn[data-cat="arts"] { border-color:var(--arts); color:var(--arts); }
  .filter-btn[data-cat="arts"] .dot { background:var(--arts); }
  .filter-btn[data-cat="food"] { border-color:var(--food); color:var(--food); }
  .filter-btn[data-cat="food"] .dot { background:var(--food); }
  .filter-btn[data-cat="hiking"] { border-color:var(--hiking); color:var(--hiking); }
  .filter-btn[data-cat="hiking"] .dot { background:var(--hiking); }
  .filter-btn[data-cat="family"] { border-color:var(--family); color:var(--family); }
  .filter-btn[data-cat="family"] .dot { background:var(--family); }
  .filter-btn[data-cat="dance"] { border-color:var(--dance); color:var(--dance); }
  .filter-btn[data-cat="dance"] .dot { background:var(--dance); }
  .filter-btn[data-cat="cowork"] { border-color:var(--cowork); color:var(--cowork); }
  .filter-btn[data-cat="cowork"] .dot { background:var(--cowork); }

  .controls { display:flex; gap:12px; justify-content:center; margin-top:8px; }
  .ctrl-btn {
    font-family:'DM Sans',sans-serif; font-size:0.7rem; font-weight:600;
    text-transform:uppercase; letter-spacing:0.08em;
    border:none; background:none; color:var(--text-muted); cursor:pointer;
    padding:2px 8px; border-radius:4px; transition:0.15s;
  }
  .ctrl-btn:hover { color:var(--text); background:rgba(0,0,0,0.04); }

  /* VIEW TOGGLE */
  .view-toggle { display:flex; justify-content:center; gap:4px; margin:16px 0 8px; }
  .view-btn {
    font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:600;
    padding:8px 20px; border:2px solid var(--border); background:white;
    cursor:pointer; transition:0.15s; color:var(--text-muted);
  }
  .view-btn:first-child { border-radius:8px 0 0 8px; }
  .view-btn:last-child { border-radius:0 8px 8px 0; }
  .view-btn.active { background:var(--text); color:white; border-color:var(--text); }

  /* MONTH HEADER */
  .month-header {
    font-family:'Playfair Display',serif; font-weight:900; font-size:1.6rem;
    margin:28px 0 16px; padding-bottom:8px; border-bottom:3px solid var(--text);
    display:flex; align-items:baseline; gap:10px;
  }
  .month-header small { font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:500; color:var(--text-muted); }

  /* GRID VIEW */
  .cal-grid {
    display:grid; grid-template-columns:repeat(7,1fr); gap:2px;
    background:var(--border); border-radius:12px; overflow:hidden; margin-bottom:32px;
  }
  .cal-grid .day-label {
    background:var(--text); color:#F5F0E8; font-size:0.7rem; font-weight:700;
    text-transform:uppercase; letter-spacing:0.1em; text-align:center; padding:8px 2px;
  }
  .cal-grid .day-cell {
    background:var(--bg-card); min-height:90px; padding:4px; position:relative;
  }
  .cal-grid .day-cell.empty { background:#F0EBE2; }
  .cal-grid .day-cell.today { box-shadow:inset 0 0 0 2px var(--community); }
  .day-num { font-size:0.75rem; font-weight:700; color:var(--text-muted); margin-bottom:2px; padding:1px 4px; }
  .day-cell.today .day-num { background:var(--community); color:white; border-radius:4px; display:inline-block; }
  .cal-dot {
    display:inline-block; width:7px; height:7px; border-radius:50%;
    margin:1px; cursor:pointer; transition:transform 0.15s;
  }
  .cal-dot:hover { transform:scale(1.6); }
  .day-events-mini { display:flex; flex-wrap:wrap; gap:0; padding:0 2px; }

  /* LIST VIEW ‚Äî EVENT CARD WITH IMAGE */
  .list-view { margin-bottom:32px; }
  .day-group { margin-bottom:2px; }
  .day-group-header {
    display:flex; align-items:center; gap:12px; padding:10px 0 6px;
    position:sticky; top:108px; background:var(--bg); z-index:10;
  }
  .day-group-date { font-family:'Playfair Display',serif; font-weight:900; font-size:1.8rem; line-height:1; min-width:44px; }
  .day-group-info { font-size:0.8rem; color:var(--text-muted); font-weight:500; }

  .event-card {
    display:flex; align-items:stretch; gap:0;
    margin:6px 0; border-radius:12px; overflow:hidden;
    background:var(--bg-card);
    border-left:4px solid;
    transition:all 0.25s;
    box-shadow:0 1px 4px var(--shadow);
  }
  .event-card:hover { box-shadow:0 6px 20px var(--shadow); transform:translateY(-2px); }
  .event-card.hidden { display:none; }

  .event-card[data-cat="community"] { border-left-color:var(--community); }
  .event-card[data-cat="music"] { border-left-color:var(--music); }
  .event-card[data-cat="yoga"] { border-left-color:var(--yoga); }
  .event-card[data-cat="festival"] { border-left-color:var(--festival); }
  .event-card[data-cat="arts"] { border-left-color:var(--arts); }
  .event-card[data-cat="food"] { border-left-color:var(--food); }
  .event-card[data-cat="hiking"] { border-left-color:var(--hiking); }
  .event-card[data-cat="family"] { border-left-color:var(--family); }
  .event-card[data-cat="dance"] { border-left-color:var(--dance); }
  .event-card[data-cat="cowork"] { border-left-color:var(--cowork); }

  .event-img-wrap {
    width:140px;
    min-height:100px;
    flex-shrink:0;
    position:relative;
    overflow:hidden;
    background:#E0D6C8;
  }
  .event-img-wrap img {
    width:100%;
    height:100%;
    object-fit:cover;
    transition:transform 0.4s;
  }
  .event-card:hover .event-img-wrap img { transform:scale(1.08); }
  .event-img-wrap .cat-badge {
    position:absolute;
    bottom:6px; left:6px;
    padding:2px 8px;
    border-radius:4px;
    font-size:0.6rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:white;
    backdrop-filter:blur(4px);
    -webkit-backdrop-filter:blur(4px);
  }

  .event-body { flex:1; min-width:0; padding:12px 16px; }
  .event-title { font-weight:700; font-size:0.9rem; margin-bottom:3px; }
  .event-meta { font-size:0.76rem; color:var(--text-muted); display:flex; flex-wrap:wrap; gap:3px 12px; }
  .event-desc { font-size:0.76rem; color:var(--text-muted); margin-top:4px; line-height:1.45; }
  .event-actions { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .gcal-link {
    display:inline-flex; align-items:center; gap:4px;
    padding:4px 10px; border-radius:6px; font-size:0.68rem; font-weight:600;
    text-decoration:none; color:white; background:var(--text);
    transition:0.15s; white-space:nowrap;
  }
  .gcal-link:hover { opacity:0.8; }
  .gcal-link svg { width:11px; height:11px; fill:currentColor; }
  .photo-credit {
    font-size:0.58rem;
    color:var(--text-muted);
    opacity:0.5;
  }
  .photo-credit a { color:var(--text-muted); text-decoration:none; }
  .photo-credit a:hover { opacity:0.8; text-decoration:underline; }

  /* RECURRING EVENTS */
  .recurring-section { margin:32px 0; padding:24px; background:var(--bg-card); border-radius:16px; border:1px solid var(--border); }
  .recurring-section h2 { font-family:'Playfair Display',serif; font-weight:900; font-size:1.3rem; margin-bottom:16px; }
  .recurring-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:10px; }
  .recurring-card {
    display:flex; align-items:stretch; gap:0;
    border-radius:10px; overflow:hidden;
    border-left:4px solid; transition:0.15s;
    background:var(--bg-card); box-shadow:0 1px 3px var(--shadow);
  }
  .recurring-card.hidden { display:none; }
  .recurring-card[data-cat="community"] { border-left-color:var(--community); }
  .recurring-card[data-cat="music"] { border-left-color:var(--music); }
  .recurring-card[data-cat="yoga"] { border-left-color:var(--yoga); }
  .recurring-card[data-cat="festival"] { border-left-color:var(--festival); }
  .recurring-card[data-cat="arts"] { border-left-color:var(--arts); }
  .recurring-card[data-cat="food"] { border-left-color:var(--food); }
  .recurring-card[data-cat="hiking"] { border-left-color:var(--hiking); }
  .recurring-card[data-cat="family"] { border-left-color:var(--family); }
  .recurring-card[data-cat="dance"] { border-left-color:var(--dance); }
  .recurring-card[data-cat="cowork"] { border-left-color:var(--cowork); }
  .rc-img {
    width:80px; flex-shrink:0; overflow:hidden;
  }
  .rc-img img { width:100%; height:100%; object-fit:cover; }
  .rc-body { padding:10px 12px; flex:1; min-width:0; }
  .rc-body strong { display:block; font-weight:700; font-size:0.82rem; margin-bottom:2px; }
  .rc-body .rc-when { font-size:0.72rem; font-weight:600; color:var(--text-muted); }
  .rc-body .rc-place { font-size:0.7rem; color:var(--text-muted); opacity:0.7; }

  /* TOOLTIP */
  .tooltip {
    display:none; position:fixed; z-index:1000;
    background:var(--text); color:#F5F0E8;
    padding:8px 12px; border-radius:8px; font-size:0.78rem;
    max-width:260px; pointer-events:none;
    box-shadow:0 8px 24px rgba(0,0,0,0.3); line-height:1.4;
  }
  .tooltip.show { display:block; }
  .tooltip strong { display:block; margin-bottom:2px; }

  .footer {
    text-align:center; padding:32px 16px; font-size:0.72rem;
    color:var(--text-muted); border-top:1px solid var(--border); margin-top:40px;
  }
  .footer a { color:var(--text-muted); }

  @media (max-width:700px) {
    .hero { height:240px; }
    .event-img-wrap { width:100px; }
    .rc-img { width:60px; }
    .cal-grid .day-cell { min-height:60px; }
    .cal-grid .day-label { font-size:0.6rem; padding:6px 1px; }
    .day-num { font-size:0.65rem; }
    .cal-dot { width:5px; height:5px; }
    .filter-btn { font-size:0.68rem; padding:4px 9px; }
    .recurring-grid { grid-template-columns:1fr; }
  }
  @media (max-width:480px) {
    .event-img-wrap { width:80px; }
    .event-title { font-size:0.82rem; }
    .event-body { padding:8px 10px; }
  }
</style>
</head>
<body>

<div class="hero">
  <img class="hero-img" src="https://live.staticflickr.com/65535/54893100875_9c7bcbc001_b.jpg" alt="Colorful papel picado banners over Oaxaca streets at night" loading="eager">
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1>Oaxaca <span>City</span></h1>
    <p>Every event worth knowing ¬∑ February & March 2026</p>
  </div>
  <div class="hero-credit">Photo by <a href="https://www.flickr.com/photos/10909746@N05/" target="_blank">Keith Mac Uidhir</a> on <a href="https://www.flickr.com/" target="_blank">Flickr</a></div>
</div>

<div class="container">
  <div class="filters-section">
    <div class="filters-wrap" id="filters"></div>
    <div class="controls">
      <button class="ctrl-btn" onclick="toggleAll(true)">Show All</button>
      <button class="ctrl-btn" onclick="toggleAll(false)">Hide All</button>
    </div>
  </div>
  <div class="view-toggle">
    <button class="view-btn active" onclick="setView('list')">List</button>
    <button class="view-btn" onclick="setView('grid')">Calendar</button>
  </div>
  <div id="list-container"></div>
  <div id="grid-container" style="display:none"></div>
  <div class="recurring-section">
    <h2>‚Üª Weekly & Recurring Events</h2>
    <div class="recurring-grid" id="recurring-grid"></div>
  </div>
</div>

<div class="footer">
  Compiled from the Oaxaca City Events Guide & Complete Guide to Settling ¬∑ Feb 2026<br>
  Photos via <a href="https://www.flickr.com/" target="_blank">Flickr</a> and <a href="https://unsplash.com" target="_blank">Unsplash</a> ‚Äî used under <a href="https://creativecommons.org/licenses/" target="_blank">Creative Commons</a> and <a href="https://unsplash.com/license" target="_blank">Unsplash</a> licenses<br>
  Event details may change ‚Äî check Instagram & WhatsApp for latest info
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ===== UNSPLASH IMAGE LIBRARY =====
// Curated CDN URLs by category with photographer credits
const IMG = {
  // ===== FLICKR IMAGES (Oaxaca-specific photography) =====
  // URL pattern: https://live.staticflickr.com/65535/{id}_{size}.jpg
  // Sizes: _m=240, _z=640, _c=800, _b=1024

  // Oaxaca general / hero
  oax_papel:     { src:'flickr', id:'54893100875_9c7bcbc001', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },
  oax_night:     { src:'flickr', id:'54897178535_8becdc8972', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },
  oax_sunnyclr:  { src:'flickr', id:'54892315215_15d05d1637', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },
  oax_stodom:    { src:'flickr', id:'55071618605_99707eab41', credit:'Don Cacheton', flickr_user:'204228832@N08' },
  oax_stodom2:   { src:'flickr', id:'43713108940_6e19ae4a90', credit:'linkogecko', flickr_user:'127492972@N04' },
  oax_colorst:   { src:'flickr', id:'55023826180_6b3dd01bcc', credit:'sparverius81', flickr_user:'8065544@N08' },
  oax_colorst2:  { src:'flickr', id:'55023504176_0eb7568f0f', credit:'sparverius81', flickr_user:'8065544@N08' },
  oax_mitla:     { src:'flickr', id:'55096562763_1df553c63f', credit:'Don Cacheton', flickr_user:'204228832@N08' },
  oax_colonial:  { src:'flickr', id:'53480889123_88eb44015b', credit:'Voyages Lambert', flickr_user:'48068124@N06' },
  oax_streetart: { src:'flickr', id:'54885954077_9a0d7e30b3', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },

  // Festival / Cultural (Oaxaca!)
  fest_devil:    { src:'flickr', id:'55093282477_d0c7f9c330', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  fest_bigeyes:  { src:'flickr', id:'55094370743_ac7d9ba5cd', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  fest_calenda:  { src:'flickr', id:'55069733824_250dc9aa88', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  fest_wedding:  { src:'flickr', id:'55091827222_c0a051fb53', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  fest_alebrije: { src:'flickr', id:'55044572521_3dde9dc77d', credit:'andywoolf', flickr_user:'181847970@N06' },
  fest_flowers:  { src:'flickr', id:'54886442641_5f97f33449', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },
  fest_masks:    { src:'flickr', id:'54564587505_a3a98d64c3', credit:'nickolosgomez', flickr_user:'105099636@N04' },
  fest_guela:    { src:'flickr', id:'54751721370_c8ff6f3a7e', credit:'Odd American', flickr_user:'23586094@N00' },

  // Food (Oaxaca!)
  food_mole:     { src:'flickr', id:'53616800141_65be340ec0', credit:'knightbefore_99', flickr_user:'9817122@N05' },
  food_tlayuda:  { src:'flickr', id:'55085012307_a2799e77ed', credit:'knightbefore_99', flickr_user:'9817122@N05' },
  food_tlayuda2: { src:'flickr', id:'54964412898_9953fdacb8', credit:'-AX-', flickr_user:'8250978@N04' },
  food_almendr:  { src:'flickr', id:'55023686523_14e552f1f9', credit:'sparverius81', flickr_user:'8065544@N08' },
  food_mezcal:   { src:'flickr', id:'55079878691_b343a8a123', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  food_choco:    { src:'flickr', id:'54878709467_64f45436f8', credit:'The Sloths', flickr_user:'12552537@N04' },
  food_chiles:   { src:'flickr', id:'54130211345_9afb797bf6', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  food_cooking:  { src:'flickr', id:'46040123392_15e2e1b557', credit:'GlobalGoebel', flickr_user:'49244654@N00' },

  // Yoga / Wellness
  yoga_outdoor:  { src:'flickr', id:'54649554309_436181de6f', credit:'alejandrovmf', flickr_user:'144495825@N06' },
  yoga_sound:    { src:'flickr', id:'53578856210_519b72efc1', credit:'Massimiliano 73', flickr_user:'200147911@N05' },
  yoga_cacao:    { src:'flickr', id:'54825137805_61c89e6708', credit:'australian ceremonial', flickr_user:'202598285@N08' },
  yoga_temazcal: { src:'flickr', id:'51441336682_8999bfe51c', credit:'Ars Electronica', flickr_user:'36085842@N06' },
  yoga1:         { src:'unsplash', id:'photo-1506126613408-eca07ce68773', credit:'Jared Rice', user:'jareddrice' },
  yoga2:         { src:'unsplash', id:'photo-1528319725582-ddc096101511', credit:'Yayan Sopian', user:'yfrSOPIAN' },

  // Music
  music_jarocho: { src:'flickr', id:'55013899553_4228608d2e', credit:'danielaherreriasfoto', flickr_user:'15228325@N00' },
  music_jarocho2:{ src:'flickr', id:'55013899298_2117fa883a', credit:'danielaherreriasfoto', flickr_user:'15228325@N00' },
  music_marimba: { src:'flickr', id:'54709287582_1921714903', credit:'Mzuriana', flickr_user:'45074625@N00' },
  music_marimba2:{ src:'flickr', id:'54156039301_74d220cc29', credit:'Teyacapan', flickr_user:'60047372@N00' },
  music_acoustic:{ src:'flickr', id:'55096091080_b41c552154', credit:'Grudnick', flickr_user:'9716802@N02' },
  music_jazz:    { src:'unsplash', id:'photo-1546872006-43d8f499a0e1', credit:'Jens Thekkeveettil', user:'jensthekkeveettil' },

  // Dance
  dance_salsa:   { src:'flickr', id:'55079597898_ef3f4f5edb', credit:'TakenByExclusiveEvents', flickr_user:'41827639@N06' },
  dance_folk:    { src:'flickr', id:'54872718554_182c9152b7', credit:'josejuanzavala', flickr_user:'126469407@N07' },
  dance_preh:    { src:'flickr', id:'54655382490_f850e0e4ce', credit:'josejuanzavala', flickr_user:'126469407@N07' },
  dance_band:    { src:'flickr', id:'55035557567_8033d72165', credit:'I saw_that', flickr_user:'88196436@N04' },
  dance1:        { src:'unsplash', id:'photo-1535525153412-5a42439a210d', credit:'Preillumination SeTh', user:'preillumination' },

  // Community
  comm_cafe:     { src:'flickr', id:'54969045484_b4fe99278d', credit:'Alex Saurel', flickr_user:'59870440@N08' },
  comm_cafe2:    { src:'flickr', id:'54641455213_c853938801', credit:'nenadstojkovicart', flickr_user:'201879762@N03' },
  comm_openmic:  { src:'flickr', id:'37612038104_a96620a22c', credit:'photographer695', flickr_user:'41087279@N00' },
  community1:    { src:'unsplash', id:'photo-1522008594266-d681be57a79b', credit:'Andrew Knechel', user:'andknecht' },
  community2:    { src:'unsplash', id:'photo-1573860838444-ae841678963d', credit:'Priscilla Du Preez', user:'priscilladupreez' },

  // Hiking (Oaxaca!)
  hike_hierve:   { src:'flickr', id:'55058894814_82e84b7d5e', credit:'www.dokumentaristen.dk', flickr_user:'70584754@N00' },
  hike_hierve2:  { src:'flickr', id:'55058999985_2a7d34544a', credit:'www.dokumentaristen.dk', flickr_user:'70584754@N00' },
  hike_monte:    { src:'flickr', id:'55078583822_54782251c1', credit:'michael.veltman', flickr_user:'73331227@N05' },
  hike_monte2:   { src:'flickr', id:'55070361757_2d0d91b024', credit:'Don Cacheton', flickr_user:'204228832@N08' },
  hike_forest:   { src:'flickr', id:'55033950311_7db1db16f0', credit:'sparverius81', flickr_user:'8065544@N08' },
  hike_forest2:  { src:'flickr', id:'55033047242_61e8068542', credit:'sparverius81', flickr_user:'8065544@N08' },

  // Arts (Oaxaca!)
  art_huipil:    { src:'flickr', id:'55092503521_554e3b9ea9', credit:'Teyacapan', flickr_user:'60047372@N00' },
  art_huipil2:   { src:'flickr', id:'55087381801_90800a97cc', credit:'Teyacapan', flickr_user:'60047372@N00' },
  art_barro:     { src:'flickr', id:'54261875230_a1f0faaae7', credit:'Thomas Roland', flickr_user:'30738927@N06' },
  art_barro2:    { src:'flickr', id:'54261689994_dfa3587666', credit:'Thomas Roland', flickr_user:'30738927@N06' },
  art_mural:     { src:'flickr', id:'54886698223_aa93dec5ab', credit:'Keith Mac Uidhir', flickr_user:'10909746@N05' },
  art_zapotec:   { src:'flickr', id:'55100211820_fac2d2a37d', credit:'Teyacapan', flickr_user:'60047372@N00' },

  // Coworking
  cowork1:       { src:'unsplash', id:'photo-1501163109389-abf37ca1276a', credit:'Shridhar Gupta', user:'shridhar' },
  cowork2:       { src:'unsplash', id:'photo-1548610325-a4e09766d5b6', credit:'Mimi Thian', user:'mimithian' },
  cowork_laptop: { src:'flickr', id:'54961333095_4833a9dd91', credit:'dejankrsmanovic', flickr_user:'155403590@N07' },

  // Family (Oaxaca!)
  fam_3gen:      { src:'flickr', id:'54914902839_d5eea7e3b2', credit:'Ilhuicamina', flickr_user:'52796712@N00' },
  fam_oaxkids:   { src:'flickr', id:'54863232586_18662a057b', credit:'N. Delbr√ºck', flickr_user:'87714242@N06' },
  fam_oaxkids2:  { src:'flickr', id:'54785036290_aff14f5998', credit:'N. Delbr√ºck', flickr_user:'87714242@N06' },
  fam_park:      { src:'flickr', id:'55034429335_65172061b4', credit:'N. Delbr√ºck', flickr_user:'87714242@N06' },
};

function imgUrl(key, w=400, h=280) {
  const i = IMG[key];
  if (!i) return '';
  if (i.src === 'flickr') {
    // Flickr: choose size suffix based on requested width
    const suffix = w > 800 ? '_b' : w > 640 ? '_c' : w > 240 ? '_z' : '_m';
    return `https://live.staticflickr.com/65535/${i.id}${suffix}.jpg`;
  }
  // Unsplash CDN with resize params
  return `https://images.unsplash.com/${i.id}?w=${w}&h=${h}&fit=crop&auto=format&q=80`;
}
function imgCredit(key) {
  const i = IMG[key];
  if (!i) return '';
  if (i.src === 'flickr') {
    return `<a href="https://www.flickr.com/photos/${i.flickr_user}/" target="_blank">${i.credit}</a>`;
  }
  return `<a href="https://unsplash.com/@${i.user}?utm_source=oaxaca_calendar&utm_medium=referral" target="_blank">${i.credit}</a>`;
}

// ===== CATEGORY IMAGE POOLS =====
const CAT_IMAGES = {
  community: ['community1','community2','comm_cafe','comm_cafe2','comm_openmic'],
  music: ['music_jarocho','music_marimba','music_acoustic','music_jazz','music_jarocho2','music_marimba2'],
  yoga: ['yoga1','yoga2','yoga_outdoor','yoga_sound','yoga_cacao','yoga_temazcal'],
  festival: ['fest_devil','fest_bigeyes','fest_calenda','fest_alebrije','fest_flowers','fest_masks','fest_guela','fest_wedding'],
  arts: ['art_huipil','art_barro','art_mural','art_zapotec','art_huipil2','art_barro2'],
  food: ['food_mole','food_tlayuda','food_mezcal','food_choco','food_almendr','food_chiles','food_cooking','food_tlayuda2'],
  hiking: ['hike_hierve','hike_monte','hike_forest','hike_hierve2','hike_monte2','hike_forest2'],
  family: ['fam_3gen','fam_oaxkids','fam_park','fam_oaxkids2'],
  dance: ['dance_salsa','dance_folk','dance_preh','dance_band','dance1'],
  cowork: ['cowork1','cowork2','cowork_laptop'],
};

let imgCounter = {};
function nextCatImg(cat) {
  const pool = CAT_IMAGES[cat] || ['oax_city'];
  if (!imgCounter[cat]) imgCounter[cat] = 0;
  const key = pool[imgCounter[cat] % pool.length];
  imgCounter[cat]++;
  return key;
}

// ===== CATEGORIES =====
const CATEGORIES = {
  community: { label:'Community & Social', color:'#B85C38' },
  music: { label:'Music & Nightlife', color:'#5C3D8F' },
  yoga: { label:'Yoga & Meditation', color:'#2D7D5F' },
  festival: { label:'Festivals & Culture', color:'#C4421A' },
  arts: { label:'Arts & Workshops', color:'#C08B30' },
  food: { label:'Food & Dining', color:'#8B6C42' },
  hiking: { label:'Hiking & Outdoors', color:'#3A7CA5' },
  family: { label:'Family & Kids', color:'#D4785C' },
  dance: { label:'Dance', color:'#A63D82' },
  cowork: { label:'Coworking & Nomad', color:'#5A7052' },
};

// ===== EVENT DATA =====
// img: specific image key override (optional)
const EVENTS = [
  { date:'2026-02-13', title:'10th Muestra de Carnavales ‚Äî Opening Parade', cat:'festival', time:'17:00', duration:3, venue:'Cruz de Piedra ‚Üí Plaza de la Danza', desc:'400‚Äì500 participants from 14 communities across 8 Oaxacan regions', img:'fest_devil' },
  { date:'2026-02-13', title:'Talisman Carnaval Art Workshop begins', cat:'arts', time:'10:00', endDate:'2026-02-22', venue:'Talism√°n Oaxaca, Santa Cruz Amilpas', desc:'7-day watercolor, mixed media & mask workshop. LAST CALL.', img:'art_huipil' },
  { date:'2026-02-13', title:'Dream Yoga Retreat ‚Äî Lama Tony Karam', cat:'yoga', time:'09:00', endDate:'2026-02-15', venue:'San Agust√≠n Etla', desc:'Casa T√≠bet M√©xico. SOLD OUT ‚Äî waitlist available.', img:'yoga1' },
  { date:'2026-02-14', title:'Carnaval Main City Parade', cat:'festival', time:'17:00', duration:3, venue:'Oaxaca Centro', desc:'The main carnival parade through the historic center.', img:'oax_colorst' },
  { date:'2026-02-17', title:'Fat Tuesday ‚Äî Village Celebrations', cat:'festival', time:'10:00', duration:8, venue:'Zaachila & San Mart√≠n Tilcajete', desc:'Zaachila: Los Zancudos stilt dancers. Tilcajete: Danza de Los Diablitos with elaborate masks.', img:'fest_flowers' },
  { date:'2026-02-17', title:'OLL Terrace Talk: Dispatches from U.S. Labor Movement', cat:'community', time:'16:30', duration:1.5, venue:'Oaxaca Lending Library', desc:'Lecture series. Tickets at oaxlibrary.org.', img:'community2' },
  { date:'2026-02-18', title:'Hike: San Miguel Chicahua ‚Üí Apoala Gorge', cat:'hiking', time:'08:00', duration:7, venue:'Departs Calle de Los Libres 710', desc:'Mod-Difficult. ~400 pesos for OLL members.', img:'hike_monte' },
  { date:'2026-02-23', title:'Hike: Zautla EcoPark', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Moderate difficulty. OLL Hoofing It program.', img:'hike_forest' },
  { date:'2026-02-24', title:'Hike: Guacamaya ‚Äì Cascada y Mirador', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Easy‚ÄìDifficult options.', img:'hike_hierve' },
  { date:'2026-02-24', title:'Lenten Tuesday #1 ‚Äî Xoxocotl√°n', cat:'festival', time:'18:00', duration:3, venue:'Santa Cruz Xoxocotl√°n', desc:'Weekly Lenten celebrations begin. Food vendors, family-friendly.', img:'oax_colonial' },
  { date:'2026-02-25', title:'2nd Oaxaca Food & Wine Festival opens', cat:'food', time:'12:00', endDate:'2026-03-01', venue:'Various Centro venues', desc:'8 events with top chefs. VIP $909 USD. 18+ only.', img:'food_mezcal' },
  { date:'2026-02-26', title:'Mezcal Tasting + Lunch ‚Äî Food & Wine Fest', cat:'food', time:'13:00', duration:3, venue:'El Tendaj√≥n', desc:'Part of the Oaxaca Food & Wine Festival.' },
  { date:'2026-02-27', title:'Caloncho in Concert', cat:'music', time:'20:00', duration:2.5, venue:'Auditorio de la URSE', desc:'Indie/Latin concert.', img:'music_marimba' },
  { date:'2026-02-27', title:'Hike: Llano Grande (Waterfall)', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Moderate difficulty.' },
  { date:'2026-02-27', title:'Talisman "Paint, Stitch, Collage" Retreat begins', cat:'arts', time:'10:00', endDate:'2026-03-08', venue:'Talism√°n Oaxaca', desc:'With Lisa Pressman & Susan Stover. SOLD OUT ‚Äî waitlist.', img:'art_barro' },
  { date:'2026-02-28', title:'Pante√≥n Rococ√≥ in Concert', cat:'music', time:'20:00', duration:3, venue:'Auditorio Guelaguetza', desc:'Alt-Latin Rock.', img:'music_jarocho' },
  { date:'2026-02-28', title:'Mole & Mezcal Calenda ‚Äî Food & Wine Fest', cat:'food', time:'17:00', duration:3, venue:'Oaxaca Centro streets', desc:'Street parade with mole and mezcal.', img:'oax_colorst2' },
  { date:'2026-02-28', title:'"In Search of Genuine Happiness" Seminar begins', cat:'yoga', time:'10:00', endDate:'2026-03-01', venue:'Casa T√≠bet CDMX (online available)', desc:'Gateway seminar for regular Buddhist classes starting March.', img:'yoga2' },
  { date:'2026-02-28', title:'Co404: La Cosecha Organic Market outing', cat:'cowork', time:'10:00', duration:3, venue:'La Cosecha Market', desc:'Co404 community activity.' },
  { date:'2026-03-01', title:'Brunch Guelaguetza ‚Äî Food & Wine Fest finale', cat:'food', time:'11:00', duration:3, venue:'Origen Restaurant', desc:'Closing event of the Oaxaca Food & Wine Festival.' },
  { date:'2026-03-03', title:'Nargaroth in Concert', cat:'music', time:'21:00', duration:2.5, venue:'Jijos del Ma√≠z', desc:'Metal.', img:'music_acoustic' },
  { date:'2026-03-03', title:'Lenten Tuesday: Regional Food & Marimba', cat:'festival', time:'18:00', duration:3, venue:'Santa Cruz Xoxocotl√°n', desc:'Themed Lenten Tuesday with regional food and marimba.' },
  { date:'2026-03-07', title:'Elefante in Concert', cat:'music', time:'20:00', duration:2.5, venue:'Auditorio Guelaguetza', desc:'Rock/Pop.' },
  { date:'2026-03-09', title:'Hike: Guacamaya ‚Äì Cascada y Mirador', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Easy‚ÄìDifficult options.' },
  { date:'2026-03-10', title:'Lenten Tuesday: Traditional Dance', cat:'festival', time:'18:00', duration:3, venue:'Santa Cruz Xoxocotl√°n', desc:'Featuring traditional dance. Family-friendly.', img:'fest_devil' },
  { date:'2026-03-11', title:'Hike: Llano de las Flores (wild horses, caves)', cat:'hiking', time:'08:00', duration:7, venue:'Departs Calle de Los Libres 710', desc:'Difficult. Wild horses and caves.' },
  { date:'2026-03-11', title:'Oaxaca Salsa & Bachata Paramount Cup opens', cat:'dance', time:'10:00', endDate:'2026-03-15', venue:'Hotel Misi√≥n Oaxaca', desc:'5-day festival: workshops, competitions, social dances, pool parties.', img:'dance1' },
  { date:'2026-03-13', title:'Ed Maverick in Concert', cat:'music', time:'20:00', duration:2, venue:'Teatro Macedonio Alcal√°', desc:'Indie/Folk.' },
  { date:'2026-03-13', title:'D√≠a de la Samaritana', cat:'festival', time:'10:00', duration:8, venue:'Throughout Centro Hist√≥rico', desc:'Free aguas frescas distributed citywide. Wonderful with a toddler.', img:'oax_colorst' },
  { date:'2026-03-13', title:'Hike: Suchilquiltongo', cat:'hiking', time:'07:00', duration:5, venue:'Departs Calle de Los Libres 710', desc:'Easy‚ÄìModerate.' },
  { date:'2026-03-14', title:'Hike: San Luis Beltran "Pink Bus Hike"', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Moderate.' },
  { date:'2026-03-18', title:'Hike: La Cumbre ‚Äì Cabeza de Vaca', cat:'hiking', time:'08:00', duration:7, venue:'Departs Calle de Los Libres 710', desc:'Moderate‚ÄìDifficult.' },
  { date:'2026-03-20', title:'"The Four Immeasurables" Retreat', cat:'yoga', time:'09:00', endDate:'2026-03-22', venue:'Casa T√≠bet M√©xico, Oaxaca', desc:'Major Buddhist retreat. Register at casatibet.org.mx.' },
  { date:'2026-03-20', title:'Talisman "Made with Paper" Workshop begins', cat:'arts', time:'10:00', endDate:'2026-03-29', venue:'Talism√°n Oaxaca, Santa Cruz Amilpas', desc:'Barro papel mask making + mixed media collage. 7 days.', img:'food_chiles' },
  { date:'2026-03-21', title:'Flans in Concert', cat:'music', time:'20:00', duration:2.5, venue:'Auditorio Guelaguetza', desc:'Pop en Espa√±ol.' },
  { date:'2026-03-24', title:'Lenten Tuesday: Music Night', cat:'festival', time:'18:00', duration:3, venue:'Santa Cruz Xoxocotl√°n', desc:'Music performances.' },
  { date:'2026-03-25', title:'Hike: El Carrizal (forest, waterfall)', cat:'hiking', time:'08:00', duration:6, venue:'Departs Calle de Los Libres 710', desc:'Moderate.' },
  { date:'2026-03-26', title:'Hridaya Bilingual Silent Meditation Retreat', cat:'yoga', time:'09:00', endDate:'2026-03-28', venue:'Hridaya Yoga, Mazunte', desc:'3-day bilingual silent meditation on the Oaxacan coast.' },
  { date:'2026-03-27', title:'Mick Jenkins in Concert', cat:'music', time:'21:00', duration:2, venue:'Pannela Callej√≥n', desc:'Hip-Hop.' },
  { date:'2026-03-27', title:'Viernes de Dolores ‚Äî Altar Displays', cat:'festival', time:'10:00', duration:10, venue:'Churches & homes, especially Jalatlaco', desc:'Beautiful altar displays. Particularly stunning in Jalatlaco.', img:'fest_flowers' },
  { date:'2026-03-28', title:'Jos√© Madero in Concert', cat:'music', time:'20:00', duration:2.5, venue:'Auditorio Guelaguetza', desc:'Rock/Pop.' },
  { date:'2026-03-28', title:'Co404: Taco Night', cat:'cowork', time:'19:00', duration:2, venue:'Co404, Benito Ju√°rez 202', desc:'Community social event.' },
  { date:'2026-03-29', title:'Palm Sunday ‚Äî Feria del Tejate', cat:'festival', time:'10:00', duration:10, venue:'San Andr√©s Huay√°pam + churches', desc:'Palm weaving, Feria del Tejate: traditional drink, tamales, nieves.', img:'oax_colonial' },
];

const RECURRING = [
  { title:'OLL Welcome to Oaxaca Q&A', cat:'community', when:'Mondays 11AM‚Äì12PM', place:'Oaxaca Lending Library', img:'community2' },
  { title:'OLL Intercambio (Language Exchange)', cat:'community', when:'Saturdays 10AM‚Äì12PM', place:'Bertelli Pavilion, OLL', img:'community1' },
  { title:'OLL Zoom Intercambio', cat:'community', when:'Sundays 4‚Äì6PM', place:'Zoom' },
  { title:'OLL Stitches (Knitting/Crochet)', cat:'community', when:'Tuesdays 10AM‚Äì1PM', place:'OLL (20-peso donation)' },
  { title:'OLL Terrace Talks', cat:'community', when:'Most evenings 4:30‚Äì6PM', place:'OLL ¬∑ oaxlibrary.org' },
  { title:'OLL Ni√±os Adelante (Kids)', cat:'family', when:'Saturdays 11AM‚Äì12:30PM', place:'OLL ¬∑ Ages 5‚Äì10, free', img:'fam_3gen' },
  { title:'Philosophy Meetups Oaxaca', cat:'community', when:'Weekly (check WhatsApp)', place:'Caf√© del Elfo, Casa de Barro', img:'community2' },
  { title:"Dary's Language Exchange", cat:'community', when:'Weekly (check IG @mezcal_speaks)', place:'Rotating ¬∑ ~100 attendees' },
  { title:'Wombat Language Exchange + Karaoke', cat:'community', when:'Thursdays 6‚Äì9PM', place:'Wombat Oaxaca' },
  { title:'Tarde de Lenguas (Multi-language)', cat:'community', when:'Saturday afternoons', place:'Rotating caf√©s' },
  { title:'Maka Hostel Happy Hour', cat:'community', when:'Daily 6‚Äì7PM', place:'Maka Hostel, Arteaga 310' },
  { title:'La Nueva Babel ‚Äî Live Music', cat:'music', when:'Nightly ~9‚Äì10PM', place:'Porfirio D√≠az 224 ¬∑ Free', img:'music_jarocho' },
  { title:'Zapotec Mixology ‚Äî Le√≥n Nafate / Band', cat:'music', when:'Fri & Sat evenings', place:'Tinoco y Palacios 604', img:'music_marimba' },
  { title:'Txalaparta ‚Äî Salsa Night', cat:'dance', when:'Thursdays 10:30PM', place:'Matamoros 208', img:'dance1' },
  { title:'Txalaparta ‚Äî Live Bands/DJs', cat:'music', when:'Fridays & Saturdays', place:'Matamoros 208' },
  { title:'Rep√∫blica Cozana ‚Äî Rooftop Shows', cat:'music', when:'Thu‚ÄìSat', place:'Murgu√≠a 102', img:'music_acoustic' },
  { title:'La J√≠cara ‚Äî Live Music & Readings', cat:'music', when:'Evenings (check IG)', place:'Porfirio D√≠az 1105' },
  { title:'Casa T√≠bet ‚Äî Free Meditation', cat:'yoga', when:'Wed 7‚Äì8PM, Sat 12‚Äì1PM', place:'San Mart√≠n 100-A', img:'yoga1' },
  { title:'MaKa Yoga ‚Äî Vinyasa Flow', cat:'yoga', when:'Tue & Thu 7:30‚Äì8:45AM', place:'Rufino Tamayo 917 ¬∑ 80 MXN' },
  { title:'Prana Yoga ‚Äî Bilingual Classes', cat:'yoga', when:'Daily (check @prana_yoga_oax)', place:'Callej√≥n del Carmen 104' },
  { title:'Casa del Angel ‚Äî Yoga & Meditation', cat:'yoga', when:'Daily (casadelangel.com.mx)', place:'Blvd la Paz 105, San Felipe', img:'yoga2' },
  { title:'Oaxaca Zen ‚Äî Meditation & Conversation', cat:'yoga', when:'Thursdays 12‚Äì1:30PM', place:'Email queave@gmail.com' },
  { title:'Ecstatic Dance Oaxaca', cat:'dance', when:'Twice monthly (check IG)', place:'Espacio Morillo ¬∑ ~150 pesos', img:'dance_folk' },
  { title:'Colectivo Aguanil√© ‚Äî Salsa/Bachata/Cumbia', cat:'dance', when:'Check social media', place:'Centro ¬∑ Donation-based', img:'dance_preh' },
  { title:'Zapotec Bar ‚Äî Bachata & Salsa', cat:'dance', when:'Evenings (8:30 & 9:30)', place:'@zapotec_oaxaca ¬∑ Donation' },
  { title:'Parque Bicentenario ‚Äî Carousel & Train', cat:'family', when:'Daily ¬∑ Rides ~1:30/5:30PM', place:'Blvd. Vasconcelos 617 ¬∑ Free', img:'fam_oaxkids' },
  { title:'Bicentenario ‚Äî Arts & Crafts', cat:'family', when:'Tue & Thu 2‚Äì3PM', place:'Parque Bicentenario ¬∑ Free' },
  { title:'CaSa Organic Market', cat:'food', when:'Sundays', place:'San Agust√≠n Etla', img:'food_mole' },
  { title:'Co404 ‚Äî Family Dinner & Activities', cat:'cowork', when:'Wednesdays + rotating', place:'Benito Ju√°rez 202', img:'cowork1' },
  { title:'Convivio ‚Äî Coworking & Events', cat:'cowork', when:'Daily cowork ¬∑ Events Wed‚ÄìSun', place:'407 Murgu√≠a ¬∑ ~$100 USD/mo' },
  { title:'Temazcal Oaxaca (Nathan Dawson)', cat:'yoga', when:'Mon‚ÄìSat by appointment', place:'Santa Mar√≠a Coyotepec ¬∑ ~1000 MXN' },
  { title:'Nabani SPAcio Hol√≠stico ‚Äî Temazcal', cat:'yoga', when:'Usually Saturdays', place:'WhatsApp +52 951 165 0777' },
  { title:'Ceviarem Temazcal', cat:'yoga', when:'Tue‚ÄìFri 11‚Äì6, Sat 11‚Äì1', place:'Tlalixtac de Cabrera ¬∑ ~$75 USD' },
];

// ===== STATE =====
let activeFilters = {};
Object.keys(CATEGORIES).forEach(k => activeFilters[k] = true);
let currentView = 'list';

// ===== GOOGLE CALENDAR LINK =====
function gcalUrl(ev) {
  const d = ev.date.replace(/-/g,'');
  let startTime = '120000';
  if (ev.time) { const [h,m] = ev.time.split(':'); startTime = h+m+'00'; }
  const dur = ev.duration||2;
  const endH = parseInt(ev.time?ev.time.split(':')[0]:12)+Math.floor(dur);
  const endM = parseInt(ev.time?ev.time.split(':')[1]:0)+Math.round((dur%1)*60);
  const endTime = String(endH).padStart(2,'0')+String(endM).padStart(2,'0')+'00';
  let dates;
  if (ev.endDate) {
    const edObj = new Date(ev.endDate); edObj.setDate(edObj.getDate()+1);
    dates = d+'/'+edObj.toISOString().slice(0,10).replace(/-/g,'');
  } else { dates = d+'T'+startTime+'/'+d+'T'+endTime; }
  return 'https://calendar.google.com/calendar/render?'+new URLSearchParams({
    action:'TEMPLATE', text:ev.title, dates, details:ev.desc||'',
    location:ev.venue||'Oaxaca City', ctz:'America/Mexico_City'
  }).toString();
}

// ===== RENDER FILTERS =====
function renderFilters() {
  const wrap = document.getElementById('filters');
  wrap.innerHTML = '';
  Object.entries(CATEGORIES).forEach(([key,val]) => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn'+(activeFilters[key]?'':' off');
    btn.dataset.cat = key;
    btn.innerHTML = `<span class="dot"></span>${val.label}`;
    btn.onclick = () => { activeFilters[key]=!activeFilters[key]; btn.classList.toggle('off'); applyFilters(); };
    wrap.appendChild(btn);
  });
}

function toggleAll(on) {
  Object.keys(activeFilters).forEach(k => activeFilters[k]=on);
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('off',!on));
  applyFilters();
}

function applyFilters() {
  document.querySelectorAll('.event-card,.recurring-card').forEach(el => {
    el.classList.toggle('hidden',!activeFilters[el.dataset.cat]);
  });
  document.querySelectorAll('.cal-dot').forEach(el => {
    el.style.display = activeFilters[el.dataset.cat]?'':'none';
  });
  document.querySelectorAll('.day-group').forEach(g => {
    g.style.display = g.querySelectorAll('.event-card:not(.hidden)').length?'':'none';
  });
}

// ===== FORMAT =====
const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS_S=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
function formatDate(ds) { const d=new Date(ds+'T12:00:00'); return DAYS[d.getDay()]+', '+MONTHS[d.getMonth()]+' '+d.getDate(); }
function formatTime(t) { if(!t) return ''; const [h,m]=t.split(':').map(Number); return (h>12?h-12:(h===0?12:h))+(m>0?':'+String(m).padStart(2,'0'):'')+' '+(h>=12?'PM':'AM'); }

// ===== RENDER LIST =====
function renderList() {
  const c = document.getElementById('list-container');
  c.innerHTML = '';
  imgCounter = {};
  const sorted = [...EVENTS].sort((a,b)=>a.date.localeCompare(b.date)||(a.time||'').localeCompare(b.time||''));
  let curMonth='', curDay='';
  sorted.forEach(ev => {
    const d=new Date(ev.date+'T12:00:00');
    const mKey=d.getFullYear()+'-'+d.getMonth();
    if (mKey!==curMonth) {
      curMonth=mKey;
      const mh=document.createElement('div'); mh.className='month-header';
      mh.innerHTML=MONTHS[d.getMonth()]+' '+d.getFullYear()+' <small>'+sorted.filter(e=>{const ed=new Date(e.date+'T12:00:00');return(ed.getFullYear()+'-'+ed.getMonth())===mKey;}).length+' events</small>';
      c.appendChild(mh);
    }
    if (ev.date!==curDay) {
      curDay=ev.date;
      const dg=document.createElement('div'); dg.className='day-group';
      dg.innerHTML=`<div class="day-group-header"><div class="day-group-date">${d.getDate()}</div><div class="day-group-info">${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}</div></div>`;
      c.appendChild(dg);
    }
    const lastGroup = c.querySelector('.day-group:last-child');
    const imgKey = ev.img || nextCatImg(ev.cat);
    const card = document.createElement('div');
    card.className='event-card'; card.dataset.cat=ev.cat;
    let meta = '';
    if (ev.time) meta+=`<span>‚è∞ ${formatTime(ev.time)}</span>`;
    if (ev.endDate) meta+=`<span>üìÖ Through ${formatDate(ev.endDate)}</span>`;
    else if (ev.duration) meta+=`<span>‚è± ${ev.duration}h</span>`;
    if (ev.venue) meta+=`<span>üìç ${ev.venue}</span>`;

    card.innerHTML = `
      <div class="event-img-wrap">
        <img src="${imgUrl(imgKey)}" alt="" loading="lazy">
        <span class="cat-badge" style="background:${CATEGORIES[ev.cat].color}cc">${CATEGORIES[ev.cat].label}</span>
      </div>
      <div class="event-body">
        <div class="event-title">${ev.title}</div>
        <div class="event-meta">${meta}</div>
        ${ev.desc?`<div class="event-desc">${ev.desc}</div>`:''}
        <div class="event-actions">
          <a class="gcal-link" href="${gcalUrl(ev)}" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
            Add to Google Cal
          </a>
          <span class="photo-credit">üì∑ ${imgCredit(imgKey)} / Unsplash</span>
        </div>
      </div>`;
    lastGroup.appendChild(card);
  });
}

// ===== RENDER GRID =====
function renderGrid() {
  const c = document.getElementById('grid-container');
  c.innerHTML = '';
  [[2026,1,'February'],[2026,2,'March']].forEach(([year,mi,mn])=>{
    const mh=document.createElement('div'); mh.className='month-header'; mh.textContent=mn+' '+year; c.appendChild(mh);
    const grid=document.createElement('div'); grid.className='cal-grid';
    DAYS_S.forEach(d=>{const l=document.createElement('div'); l.className='day-label'; l.textContent=d; grid.appendChild(l);});
    const first=new Date(year,mi,1), dim=new Date(year,mi+1,0).getDate(), sd=first.getDay();
    for(let i=0;i<sd;i++){const ce=document.createElement('div');ce.className='day-cell empty';grid.appendChild(ce);}
    const today=new Date();
    for(let d=1;d<=dim;d++){
      const cell=document.createElement('div'), ds=year+'-'+String(mi+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      cell.className='day-cell';
      if(today.getFullYear()===year&&today.getMonth()===mi&&today.getDate()===d) cell.classList.add('today');
      cell.innerHTML=`<div class="day-num">${d}</div><div class="day-events-mini"></div>`;
      EVENTS.filter(ev=>ev.date===ds||(ev.endDate&&ev.date<=ds&&ev.endDate>=ds)).forEach(ev=>{
        const dot=document.createElement('span'); dot.className='cal-dot'; dot.dataset.cat=ev.cat;
        dot.style.background=CATEGORIES[ev.cat].color; dot.dataset.title=ev.title;
        dot.dataset.time=ev.time?formatTime(ev.time):''; dot.dataset.venue=ev.venue||'';
        dot.onmouseenter=showTooltip; dot.onmouseleave=hideTooltip;
        dot.onclick=()=>window.open(gcalUrl(ev),'_blank');
        cell.querySelector('.day-events-mini').appendChild(dot);
      });
      grid.appendChild(cell);
    }
    c.appendChild(grid);
  });
}

// ===== TOOLTIP =====
function showTooltip(e){
  const t=document.getElementById('tooltip'), d=e.target;
  t.innerHTML=`<strong>${d.dataset.title}</strong>${d.dataset.time?d.dataset.time+'<br>':''}${d.dataset.venue?'<span style="opacity:.7">'+d.dataset.venue+'</span>':''}<br><span style="font-size:.65rem;opacity:.5">Click to add to Google Calendar</span>`;
  t.classList.add('show');
  const r=d.getBoundingClientRect();
  t.style.left=Math.min(r.left,window.innerWidth-280)+'px';
  t.style.top=(r.bottom+8)+'px';
}
function hideTooltip(){document.getElementById('tooltip').classList.remove('show');}

// ===== RENDER RECURRING =====
function renderRecurring(){
  const g=document.getElementById('recurring-grid');
  g.innerHTML='';
  imgCounter={};
  RECURRING.forEach(r=>{
    const imgKey = r.img || nextCatImg(r.cat);
    const card=document.createElement('div'); card.className='recurring-card'; card.dataset.cat=r.cat;
    card.innerHTML=`
      <div class="rc-img"><img src="${imgUrl(imgKey,160,160)}" alt="" loading="lazy"></div>
      <div class="rc-body">
        <strong>${r.title}</strong>
        <div class="rc-when">${r.when}</div>
        <div class="rc-place">${r.place}</div>
      </div>`;
    g.appendChild(card);
  });
}

// ===== VIEW =====
function setView(v){
  currentView=v;
  document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
  if(v==='list'){
    document.querySelectorAll('.view-btn')[0].classList.add('active');
    document.getElementById('list-container').style.display='';
    document.getElementById('grid-container').style.display='none';
  } else {
    document.querySelectorAll('.view-btn')[1].classList.add('active');
    document.getElementById('list-container').style.display='none';
    document.getElementById('grid-container').style.display='';
  }
}

// ===== INIT =====
renderFilters(); renderList(); renderGrid(); renderRecurring(); applyFilters();
</script>
</body>
</html>